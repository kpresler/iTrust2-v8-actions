name: GitHub Actions Demo
on: [push]
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v2
      - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ðŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - run: echo "ðŸ This job's status is ${{ job.status }}."
      
      
      - name: Setup JDK 11
        uses: actions/setup-java@v1.4.3
        with:
          java-version: '11'

      - name: Copy config files
        run: cp iTrust2/src/main/resources/application.yml.template iTrust2/src/main/resources/application.yml
        
        
      - name: Shutdown Ubuntu MySQL
        run: sudo service mysql stop # Shutdown the Default MySQL, "sudo" is necessary, please not remove it

      - name: Set up MySQL
        run: docker run --name mariadbtest -e MYSQL_ROOT_PASSWORD=root1234 -p 3306:3306 -d docker.io/library/mariadb:10.4
          
      - name: Wait for container to be alive
        run: sleep 15s      
         
      - name: Check DB
        run: mysql -uroot -h 0.0.0.0 -proot1234 -e 'SELECT version()'
      

      - name: Build with Maven
        run: cd iTrust2 && mvn --batch-mode --update-snapshots clean test
        
 
      - name: Badge Generator
        id: jacoco
        run: > 
            python3 generate_badge.py "iTrust2/target/site/jacoco-ut/jacoco.csv"
            ".github/badges" "jacoco.svg" "branches.svg" "true" "true"
            "fail" "75" "50" "false" "false" "100 90 80 70 60 0" "#4c1 #97ca00 #a4a61d #dfb317 #fe7d37 #e05d44"
            
            
      - name: Log coverage percentage
        if: always()
        run: |
          echo "coverage = ${{ steps.jacoco.outputs.coverage }}"
          echo "branch coverage = ${{ steps.jacoco.outputs.branches }}"
          
      - name: Run CheckStyle
        if: always()
        run: |
          java -jar checkstyle-8.44-all.jar -c checkstyle.xml -x .*test.* iTrust2/ > checkstyle.log  
          if cat checkstyle.log | grep WARN | wc -l > 0; then echo "$(tput setaf 3)Warning!  There are $(cat checkstyle.log | grep WARN | wc -l) checkstyle warnings.  Take a look at the log below to figure out what:$(tput sgr 0)" && cat checkstyle.log; else echo "$(tput setaf 2)Checkstyle passed successfully!$(tput sgr 0)"; fi

          
      - name: Commit the badge (if it changed)
        if: always()
        run: |
          if [[ `git status --porcelain` ]]; then
            git config --global user.name 'GLaDOS (Bot)'
            git config --global user.email 'glados@users.noreply.github.com'
            git add -A
            git commit -m "Autogenerated JaCoCo coverage badge"
            git push
          fi
